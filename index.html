<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<title>Araç Analiz Sistemi</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
body{
font-family:Arial;
background:linear-gradient(135deg,#0a3cff,#0ad0ff);
color:white;
text-align:center;
}
.box{
background:white;
color:black;
width:420px;
margin:20px auto;
padding:20px;
border-radius:12px;
}
input,button{
width:100%;
padding:10px;
margin:6px 0;
}
button{
background:#0a3cff;
color:white;
border:none;
cursor:pointer;
}
.hidden{display:none}
</style>
</head>

<body>

<h1>Araç Analiz Sistemi</h1>

<div class="box" id="authBox">
<h3>Kayıt / Giriş</h3>
<input id="email" placeholder="Email">
<input id="password" type="password" placeholder="Şifre">
<button onclick="register()">Kayıt Ol</button>
<button onclick="login()">Giriş Yap</button>
</div>

<div class="box hidden" id="userPanel">
<h3>Plaka Sorgu</h3>
<input id="plate" placeholder="Plaka">

<button onclick="buySingle()">Tek Sorgu Satın Al (30 TL)</button>
<button onclick="buyMembership()">Aylık Üyelik Al</button>
<button onclick="analyze()">Analiz Oluştur</button>
<button onclick="logout()">Çıkış Yap</button>

<div id="result"></div>
</div>

<div class="box hidden" id="adminPanel">
<h3>Admin Panel</h3>
<h4>Araç Ekle</h4>
<input id="a_plate" placeholder="Plaka">
<input id="a_brand" placeholder="Marka">
<input id="a_model" placeholder="Model">
<input id="a_year" placeholder="Yıl">
<input id="a_km" placeholder="KM">
<input id="a_exp" placeholder="Ekspertiz">
<button onclick="addVehicle()">Kaydet</button>

<h4>Kullanıcılar</h4>
<div id="users"></div>
</div>

<script>

const SUPABASE_URL="https://arac-analiz.vercel.app";
const SUPABASE_ANON_KEY="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imx4dXFwemlxeXJyd3R6Y2tzZ3d6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA1NDM4MzMsImV4cCI6MjA4NjExOTgzM30.WOwK1D4eDNyPxYOe7HUuwndgPFQgmdmCcRxWsfyTSps";
const db=supabase.createClient(SUPABASE_URL,SUPABASE_ANON_KEY);

let currentUser=null;

async function register(){
let email=document.getElementById("email").value;
let password=document.getElementById("password").value;
await db.auth.signUp({email,password});
alert("Mail onayla");
}

async function login(){
let email=document.getElementById("email").value;
let password=document.getElementById("password").value;
let {data}=await db.auth.signInWithPassword({email,password});
currentUser=data.user;
initUser();
}

async function logout(){
await db.auth.signOut();
location.reload();
}

async function initUser(){
document.getElementById("authBox").classList.add("hidden");
document.getElementById("userPanel").classList.remove("hidden");

let {data:profile}=await db.from("profiles").select("*").eq("id",currentUser.id).single();

if(profile.is_admin){
document.getElementById("adminPanel").classList.remove("hidden");
loadUsers();
}

if(profile.membership_until && new Date(profile.membership_until)<new Date()){
alert("Üyelik süren dolmuş");
}
}

async function buyMembership(){
await db.from("profiles").update({
membership_until:new Date(Date.now()+30*86400000)
}).eq("id",currentUser.id);

alert("Üyelik aktif");
}

async function buySingle(){
await db.from("profiles").update({single_query:true}).eq("id",currentUser.id);
alert("Tek sorgu aktif");
}

function calculateScore(year,km){
let score=100;
let age=new Date().getFullYear()-year;
score-=age*2;
if(km>200000)score-=20;
if(km>300000)score-=30;
return Math.max(score,10);
}

function kmRisk(km,year){
let avg=(new Date().getFullYear()-year)*15000;
return km>avg*1.7 ? "KM ŞÜPHELİ" : "Normal";
}

async function analyze(){
let plate=document.getElementById("plate").value;
let {data:vehicle}=await db.from("vehicles").select("*").eq("plate",plate).single();

if(!vehicle){
alert("Araç bulunamadı");
return;
}

let score=calculateScore(vehicle.year,vehicle.km);
let risk=kmRisk(vehicle.km,vehicle.year);

document.getElementById("result").innerHTML=
`
<h3>${vehicle.brand} ${vehicle.model}</h3>
Güven Puanı: ${score}<br>
KM Durum: ${risk}<br>
Ekspertiz: ${vehicle.expertiz}<br>
<button onclick="downloadPDF('${vehicle.brand}','${vehicle.model}','${score}','${risk}')">PDF İndir</button>
`;

await db.from("logs").insert({
user_id:currentUser.id,
email:currentUser.email,
action:"analiz:"+plate
});
}

function downloadPDF(brand,model,score,risk){
const {jsPDF}=window.jspdf;
let doc=new jsPDF();
doc.text("Araç Analiz Raporu",20,20);
doc.text("Araç: "+brand+" "+model,20,40);
doc.text("Güven Puanı: "+score,20,60);
doc.text("Risk: "+risk,20,80);
doc.save("rapor.pdf");
}

async function addVehicle(){
let plate=document.getElementById("a_plate").value;
let brand=document.getElementById("a_brand").value;
let model=document.getElementById("a_model").value;
let year=document.getElementById("a_year").value;
let km=document.getElementById("a_km").value;
let expertiz=document.getElementById("a_exp").value;

await db.from("vehicles").insert({
plate,brand,model,year,km,expertiz
});

alert("Araç eklendi");
}

async function loadUsers(){
let {data}=await db.from("profiles").select("id,email,is_admin");
let html="";
data.forEach(u=>{
html+=`
<div>
${u.email} 
<button onclick="makeAdmin('${u.id}')">Admin Yap</button>
</div>
`;
});
document.getElementById("users").innerHTML=html;
}

async function makeAdmin(id){
await db.from("profiles").update({is_admin:true}).eq("id",id);
alert("Admin verildi");
}

</script>
</body>
</html>
