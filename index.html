<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Araç Analiz Sistemi</title>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
body{font-family:Arial;background:#0d47a1;color:white;text-align:center;padding:20px}
.box{background:white;color:black;padding:20px;border-radius:10px;max-width:450px;margin:auto;margin-top:20px}
input,button{padding:10px;width:100%;margin-top:10px}
button{background:#0d47a1;color:white;border:none;cursor:pointer}
.hidden{display:none}
</style>
</head>

<body>

<h1>Araç Analiz Sistemi</h1>

<div class="box" id="authBox">
<h3>Giriş</h3>
<input type="email" id="email" placeholder="Email">
<input type="password" id="password" placeholder="Şifre">
<button onclick="register()">Kayıt Ol</button>
<button onclick="login()">Giriş Yap</button>
</div>

<div class="box hidden" id="userPanel">
<h3>Plaka Sorgu</h3>
<input id="plaka" placeholder="Plaka">
<button onclick="plakaSorgu()">Sorgula</button>
<button onclick="logout()">Çıkış Yap</button>
</div>

<div class="box hidden" id="adminPanel">
<h3>Admin Panel</h3>

<h4>Admin Yap</h4>
<input id="adminEmail" placeholder="Email">
<button onclick="makeAdmin()">Admin Yap</button>

<hr>

<h4>Araç Ekle</h4>
<input id="v_plaka" placeholder="Plaka">
<input id="v_marka" placeholder="Marka">
<input id="v_model" placeholder="Model">
<input id="v_yil" placeholder="Yıl">
<input id="v_hasar" placeholder="Hasar">
<input id="v_ekspertiz" placeholder="Ekspertiz">
<button onclick="aracEkle()">Kaydet</button>

<hr>

<button onclick="loglariGetir()">İşlem Logları</button>
<div id="loglar"></div>

</div>

<script>

const SUPABASE_URL="https://lxuqpziqyrrwtzcksgwz.supabase.co";
const SUPABASE_ANON_KEY="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imx4dXFwemlxeXJyd3R6Y2tzZ3d6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA1NDM4MzMsImV4cCI6MjA4NjExOTgzM30.WOwK1D4eDNyPxYOe7HUuwndgPFQgmdmCcRxWsfyTSps";

const { createClient } = supabase;
const db=createClient(SUPABASE_URL,SUPABASE_ANON_KEY);

async function register(){
const email=emailEl().value;
const password=passwordEl().value;
const {error}=await db.auth.signUp({email,password});
if(error) alert(error.message);
else alert("Kayıt başarılı. Mailini onayla.");
}

async function login(){
const email=emailEl().value;
const password=passwordEl().value;

const {data,error}=await db.auth.signInWithPassword({email,password});
if(error) return alert(error.message);
if(!data.user.email_confirmed_at) return alert("Email doğrulanmamış");

showUser();
checkAdmin();
}

function showUser(){
authBox().classList.add("hidden");
userPanel().classList.remove("hidden");
}

async function logout(){
await db.auth.signOut();
location.reload();
}

async function checkAdmin(){
const {data:{user}}=await db.auth.getUser();
const {data}=await db.from("profiles").select("is_admin").eq("id",user.id).single();
if(data?.is_admin) adminPanel().classList.remove("hidden");
}

async function makeAdmin(){
const email=adminEmail().value;
const {data}=await db.from("profiles").update({is_admin:true}).eq("email",email);
alert("Admin yapıldı");
await logYaz("admin yetki verdi");
}

async function aracEkle(){
await db.from("vehicles").insert({
plaka:v_plaka.value.toUpperCase(),
marka:v_marka.value,
model:v_model.value,
yil:v_yil.value,
hasar:v_hasar.value,
ekspertiz:v_ekspertiz.value
});
alert("Araç kaydedildi");
await logYaz("araç ekledi");
}

async function plakaSorgu(){
const plaka=plakaEl().value.toUpperCase();

const {data}=await db.from("vehicles").select("*").eq("plaka",plaka).single();

if(!data) return alert("Araç bulunamadı");

alert(
"Plaka: "+data.plaka+
"\nMarka: "+data.marka+
"\nModel: "+data.model+
"\nYıl: "+data.yil+
"\nHasar: "+data.hasar+
"\nEkspertiz: "+data.ekspertiz
);

await logYaz("plaka sorguladı");
}

async function logYaz(action){
const {data:{user}}=await db.auth.getUser();
await db.from("logs").insert({
user_id:user.id,
email:user.email,
action:action
});
}

async function loglariGetir(){
const {data}=await db.from("logs").select("*").order("created_at",{ascending:false}).limit(50);

let html="";
data.forEach(l=>{
html+=<p>${l.email} → ${l.action} (${l.created_at})</p>;
});

loglar().innerHTML=html;
}

// helpers
const emailEl=()=>document.getElementById("email");
const passwordEl=()=>document.getElementById("password");
const authBox=()=>document.getElementById("authBox");
const userPanel=()=>document.getElementById("userPanel");
const adminPanel=()=>document.getElementById("adminPanel");
const plakaEl=()=>document.getElementById("plaka");
const adminEmail=()=>document.getElementById("adminEmail");
const loglar=()=>document.getElementById("loglar");

</script>
</body>
</html>
