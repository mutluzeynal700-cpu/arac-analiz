<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>AraÃ§ Analiz</title>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
body{font-family:Arial;background:#0d47a1;color:white;text-align:center;padding:20px;}
.box{background:white;color:black;padding:20px;border-radius:10px;max-width:500px;margin:auto;margin-top:20px;}
input,button{padding:10px;width:100%;margin-top:10px;}
button{background:#0d47a1;color:white;border:none;cursor:pointer;}
.hidden{display:none;}
.admin{background:#222;color:white;}
</style>
</head>
<body>

<h1>AraÃ§ Analiz Sistemi</h1>

<!-- AUTH -->
<div class="box" id="authBox">
<h3>GiriÅŸ</h3>
<input type="email" id="email" placeholder="Email">
<input type="password" id="password" placeholder="Åifre">
<button onclick="register()">KayÄ±t Ol</button>
<button onclick="login()">GiriÅŸ Yap</button>
</div>

<!-- TOS -->
<div class="box hidden" id="tosBox">
<h3>KullanÄ±cÄ± SÃ¶zleÅŸmesi</h3>
<label><input type="checkbox" id="tosCheck"> Okudum kabul ediyorum</label>
<button onclick="acceptTOS()">Devam</button>
</div>

<!-- USER PANEL -->
<div class="box hidden" id="panel">
<h3>KullanÄ±cÄ± Paneli</h3>

<p><b>Ãœyelik:</b> <span id="uyelikDurum"></span></p>
<p><b>Kalan Tek Sorgu:</b> <span id="hakSayisi"></span></p>
<p><b>Ãœyelik BitiÅŸ:</b> <span id="bitis"></span></p>

<hr>

<input id="plaka" placeholder="Plaka gir">
<button onclick="plakaSorgu()">Plaka Sorgula</button>

<hr>

<button onclick="tekSorgu()">30 TL Tek Sorgu</button>
<button onclick="uyelik()">AylÄ±k Ãœyelik</button>

<button onclick="logout()">Ã‡Ä±kÄ±ÅŸ</button>
</div>

<!-- ADMIN PANEL -->
<div class="box admin hidden" id="adminPanel">
<h3>Admin Panel</h3>
<button onclick="kullanicilariGetir()">KullanÄ±cÄ±larÄ± Listele</button>
<div id="adminListe"></div>
</div>

<script>
const SUPABASE_URL="https://lxuqpziqyrrwtzcksgwz.supabase.co";
const SUPABASE_ANON_KEY="BURAYA_ANON_KEY";

const { createClient } = supabase;
const db = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

// ADMIN EMAIL
const ADMIN_EMAIL="mslmcanlii@gmail.com";

const emailEl=document.getElementById("email");
const passwordEl=document.getElementById("password");
const authBox=document.getElementById("authBox");
const tosBox=document.getElementById("tosBox");
const panel=document.getElementById("panel");
const adminPanel=document.getElementById("adminPanel");

async function register(){
const { data, error } = await db.auth.signUp({
email:emailEl.value,
password:passwordEl.value
});
if(error)return alert(error.message);

await db.from("profiles").insert([
{id:data.user.id,email:emailEl.value}
]);

alert("KaydÄ±nÄ±z baÅŸarÄ±yla gerÃ§ekleÅŸmiÅŸtir. LÃ¼tfen emailinizi doÄŸrulayÄ±n.");
}

async function login(){
const { data, error } = await db.auth.signInWithPassword({
email:emailEl.value,
password:passwordEl.value
});
if(error)return alert(error.message);

const { data:profile } = await db
.from("profiles").select("*")
.eq("id",data.user.id).single();

authBox.classList.add("hidden");

if(!profile.tos_accepted){
tosBox.classList.remove("hidden");
return;
}

panel.classList.remove("hidden");
kullaniciBilgiGoster(profile);

// ADMIN KONTROL
if(data.user.email===ADMIN_EMAIL){
adminPanel.classList.remove("hidden");
}
}

async function acceptTOS(){
const { data:{user} } = await db.auth.getUser();
await db.from("profiles").update({
tos_accepted:true
}).eq("id",user.id);

tosBox.classList.add("hidden");
panel.classList.remove("hidden");
}

function kullaniciBilgiGoster(profile){
document.getElementById("uyelikDurum").innerText=profile.membership_status;
document.getElementById("hakSayisi").innerText=profile.tek_sorgu_hak;
document.getElementById("bitis").innerText=profile.membership_end || "-";
}

async function tekSorgu(){
const { data:{user} } = await db.auth.getUser();

const { data:profile } = await db
.from("profiles").select("tek_sorgu_hak")
.eq("id",user.id).single();

await db.from("profiles").update({
tek_sorgu_hak:(profile.tek_sorgu_hak||0)+1
}).eq("id",user.id);

alert("1 sorgu hakkÄ± eklendi");
}

async function uyelik(){
const { data:{user} } = await db.auth.getUser();
const bitis=new Date();
bitis.setMonth(bitis.getMonth()+1);

await db.from("profiles").update({
membership_status:"aktif",
membership_end:bitis
}).eq("id",user.id);

alert("Ãœyelik aktif");
}

async function plakaSorgu(){
const plaka=document.getElementById("plaka").value.toUpperCase();
if(!plaka)return alert("Plaka gir");

const { data:{user} } = await db.auth.getUser();
const { data:profile } = await db
.from("profiles").select("*")
.eq("id",user.id).single();

if(profile.membership_status==="aktif"){
plakaApi(plaka);
return;
}

if(profile.tek_sorgu_hak>0){
await db.from("profiles").update({
tek_sorgu_hak:profile.tek_sorgu_hak-1
}).eq("id",user.id);

plakaApi(plaka);
return;
}

alert("Sorgu hakkÄ±nÄ±z yok");
}

// ğŸ”¥ BURAYA GERÃ‡EK PLAKA API BAÄLANACAK
async function plakaApi(plaka){
alert("Plaka sorgu sonucu (demo): "+plaka);

// Ã–RNEK API BAÄLAMA ÅABLONU
/*
const res = await fetch("API_URL?plaka="+plaka);
const data = await res.json();
alert(JSON.stringify(data));
*/
}

async function kullanicilariGetir(){
const { data } = await db.from("profiles").select("*");

let html="";
data.forEach(u=>{
html+=<p>${u.email} | Ãœyelik:${u.membership_status} | Hak:${u.tek_sorgu_hak}</p>;
});
document.getElementById("adminListe").innerHTML=html;
}

async function logout(){
await db.auth.signOut();
location.reload();
}
</script>

</body>
</html>
