<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Araç Analiz PRO</title>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/supabase.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
body{
font-family:Arial;
background:linear-gradient(135deg,#0a3cff,#0ad0ff);
color:white;
text-align:center;
margin:0;
}

.container{
max-width:420px;
margin:auto;
padding:15px;
}

.box{
background:white;
color:black;
padding:20px;
border-radius:14px;
margin-top:20px;
box-shadow:0 10px 30px rgba(0,0,0,0.2);
}

input,button{
width:100%;
padding:12px;
margin:6px 0;
border-radius:8px;
border:none;
font-size:15px;
}

button{
background:#0a3cff;
color:white;
cursor:pointer;
font-weight:bold;
}

.hidden{display:none}
</style>
</head>

<body>

<div class="container">

<h1>Araç Analiz PRO</h1>

<div class="box" id="authBox">
<h3>Kayıt / Giriş</h3>
<input id="email" placeholder="Email" autocomplete="off">
<input id="password" type="password" placeholder="Şifre" autocomplete="new-password">
<button onclick="register()">Kayıt Ol</button>
<button onclick="login()">Giriş Yap</button>
</div>

<div class="box hidden" id="userPanel">
<h3>Plaka Sorgu</h3>
<input id="plate" placeholder="Plaka">
<button onclick="analyze()">Analiz Yap</button>
<button onclick="logout()">Çıkış</button>
<div id="result"></div>
</div>

<div class="box hidden" id="adminPanel">
<h3>Admin Panel</h3>
<input id="a_plate" placeholder="Plaka">
<input id="a_brand" placeholder="Marka">
<input id="a_model" placeholder="Model">
<input id="a_year" placeholder="Yıl">
<input id="a_km" placeholder="KM">
<input id="a_exp" placeholder="Ekspertiz">
<button onclick="addVehicle()">Araç Kaydet</button>
</div>

</div>

<script>
const SUPABASE_URL="https://lxuqpziqyrrwtzcksgwz.supabase.co";
const SUPABASE_ANON_KEY="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imx4dXFwemlxeXJyd3R6Y2tzZ3d6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA1NDM4MzMsImV4cCI6MjA4NjExOTgzM30.WOwK1D4eDNyPxYOe7HUuwndgPFQgmdmCcRxWsfyTSps";
const db=supabase.createClient(SUPABASE_URL,SUPABASE_ANON_KEY);

let currentUser=null;

window.onload=()=>{ document.getElementById("email").value=""; }

async function register(){
let email=emailVal();
let password=passVal();

let {error}=await db.auth.signUp({email,password});

if(error){ alert(error.message); return; }

alert("Kayıt başarılı. Mail onayı yapıp giriş yap.");
}

async function login(){
let email=emailVal();
let password=passVal();

let {data,error}=await db.auth.signInWithPassword({email,password});

if(error){ alert(error.message); return; }

currentUser=data.user;
initUser();
}

async function logout(){
await db.auth.signOut();
location.reload();
}

async function initUser(){
hide("authBox");
show("userPanel");

let {data:profile}=await db.from("profiles").select("*").eq("id",currentUser.id).single();

if(profile?.is_admin) show("adminPanel");
}

async function analyze(){
let plate=document.getElementById("plate").value;
let {data,error}=await db.from("vehicles").select("*").eq("plate",plate).single();

if(error||!data){ alert("Araç bulunamadı"); return; }

let score=calcScore(data.year,data.km);

document.getElementById("result").innerHTML=`
<h3>${data.brand} ${data.model}</h3>
Güven Puanı: ${score}<br>
KM: ${data.km}<br>
Ekspertiz: ${data.expertiz}<br>
<button onclick="pdf('${data.brand}','${data.model}','${score}')">PDF İndir</button>
`;
}

async function addVehicle(){
await db.from("vehicles").insert({
plate:v("a_plate"),
brand:v("a_brand"),
model:v("a_model"),
year:v("a_year"),
km:v("a_km"),
expertiz:v("a_exp")
});
alert("Araç eklendi");
}

function calcScore(year,km){
let score=100;
let age=new Date().getFullYear()-year;
score-=age*2;
if(km>200000)score-=20;
return Math.max(score,10);
}

function pdf(brand,model,score){
const {jsPDF}=window.jspdf;
let doc=new jsPDF();
doc.text("Araç Analiz PRO",20,20);
doc.text(brand+" "+model,20,40);
doc.text("Güven: "+score,20,60);
doc.save("rapor.pdf");
}

function v(id){return document.getElementById(id).value}
function emailVal(){return v("email")}
function passVal(){return v("password")}
function show(id){document.getElementById(id).classList.remove("hidden")}
function hide(id){document.getElementById(id).classList.add("hidden")}
</script>

</body>
</html>
