<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Araç Analiz</title>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
body{font-family:Arial;background:#0d47a1;color:white;text-align:center;padding:20px;}
.box{background:white;color:black;padding:20px;border-radius:10px;max-width:450px;margin:auto;margin-top:20px;}
input,button{padding:10px;width:100%;margin-top:10px;}
button{background:#0d47a1;color:white;border:none;cursor:pointer;}
.hidden{display:none;}
</style>
</head>
<body>

<h1>Araç Analiz</h1>

<div class="box" id="authBox">
<h3>Giriş</h3>
<input type="email" id="email" placeholder="Email">
<input type="password" id="password" placeholder="Şifre">
<button onclick="register()">Kayıt Ol</button>
<button onclick="login()">Giriş Yap</button>
</div>

<div class="box hidden" id="tosBox">
<h3>Kullanıcı Sözleşmesi</h3>
<label><input type="checkbox" id="tosCheck"> Okudum kabul ediyorum</label>
<button onclick="acceptTOS()">Devam</button>
</div>

<div class="box hidden" id="panel">
<h3>Plaka Sorgu</h3>
<input id="plaka" placeholder="Plaka">
<button onclick="plakaSorgu()">Sorgula</button>

<hr>

<h3>Analiz Satın Al</h3>
<button onclick="tekSorgu()">30 TL Tek Sorgu</button>
<button onclick="uyelik()">Aylık Üyelik</button>

<button onclick="logout()">Çıkış</button>
</div>

<script>
const SUPABASE_URL="https://lxuqpziqyrrwtzcksgwz.supabase.co";
const SUPABASE_ANON_KEY="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imx4dXFwemlxeXJyd3R6Y2tzZ3d6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA1NDM4MzMsImV4cCI6MjA4NjExOTgzM30.WOwK1D4eDNyPxYOe7HUuwndgPFQgmdmCcRxWsfyTSps";

const { createClient } = supabase;
const db = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

const emailEl=document.getElementById("email");
const passwordEl=document.getElementById("password");
const authBox=document.getElementById("authBox");
const tosBox=document.getElementById("tosBox");
const panel=document.getElementById("panel");
const tosCheck=document.getElementById("tosCheck");

async function register(){
const email=emailEl.value;
const password=passwordEl.value;

const { data, error } = await db.auth.signUp({email,password});
if(error)return alert(error.message);

await db.from("profiles").insert([{id:data.user.id,email}]);

alert("Kaydınız başarıyla gerçekleşmiştir. Lütfen hesabınızı aktifleştirmek için emailinizi kontrol ediniz.");
}

async function login(){
const email=emailEl.value;
const password=passwordEl.value;

const { data, error } = await db.auth.signInWithPassword({email,password});
if(error)return alert(error.message);

const { data:profile } = await db.from("profiles").select("*").eq("id",data.user.id).single();

authBox.classList.add("hidden");

if(!profile.tos_accepted) tosBox.classList.remove("hidden");
else panel.classList.remove("hidden");
}

async function acceptTOS(){
if(!tosCheck.checked)return alert("Onay gerekli");

const { data:{user} } = await db.auth.getUser();
await db.from("profiles").update({tos_accepted:true}).eq("id",user.id);

tosBox.classList.add("hidden");
panel.classList.remove("hidden");
}

async function tekSorgu(){
const { data:{user} } = await db.auth.getUser();
await db.from("odemeler").insert([{user_id:user.id,tip:"tek",tutar:30}]);
alert("Tek sorgu hakkı verildi (demo)");
}

async function uyelik(){
const { data:{user} } = await db.auth.getUser();
const bitis=new Date();
bitis.setMonth(bitis.getMonth()+1);

await db.from("profiles").update({
membership_status:"aktif",
membership_end:bitis
}).eq("id",user.id);

alert("Üyelik aktif");
}

async function plakaSorgu(){
const { data:{user} } = await db.auth.getUser();
const { data:profile } = await db.from("profiles").select("*").eq("id",user.id).single();

if(profile.membership_status==="aktif"){
alert("Sınırsız sorgu hakkın var");
return;
}

alert("Tek sorgu kullanıldı (demo)");
}

async function logout(){
await db.auth.signOut();
location.reload();
}
</script>

</body>
</html>
