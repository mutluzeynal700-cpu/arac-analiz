<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Araç Analiz Sistemi</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
body{
    font-family: Arial;
    background:#0d47a1;
    color:white;
    text-align:center;
    padding:30px;
}
.box{
    background:white;
    color:black;
    padding:20px;
    border-radius:10px;
    max-width:400px;
    margin:auto;
    margin-top:20px;
}
input,button{
    padding:10px;
    width:100%;
    margin-top:10px;
}
button{
    background:#0d47a1;
    color:white;
    border:none;
    cursor:pointer;
}
</style>
</head>
<body>

<h1>Araç Analiz</h1>

<!-- LOGIN -->
<div class="box" id="loginBox">
    <h3>Giriş</h3>
    <input type="email" id="email" placeholder="Email">
    <input type="password" id="password" placeholder="Şifre">
    <button onclick="register()">Kayıt Ol</button>
    <button onclick="login()">Giriş Yap</button>
</div>

<!-- SATIN AL SEÇİM -->
<div class="box" id="buyBox" style="display:none;">
    <h3>Paket Seç</h3>
    <button onclick="tekSorguAl()">Tek Sorgu (30 TL)</button>
    <button onclick="uyelikAl()">30 Gün Üyelik (99 TL)</button>
</div>

<!-- PLAKA -->
<div class="box" id="plakaBox" style="display:none;">
    <h3>Plaka Sorgula</h3>
    <input type="text" id="plaka" placeholder="34ABC123">
    <button onclick="sorgula()">Sorgula</button>
    <div id="sonuc"></div>
</div>

<script>

const supabaseUrl = 'https://lxuqpziqyrrwtzcksgwz.supabase.co'
const supabaseKey = 'BURAYA_KENDI_ANON_KEYINI_YAPISTIR'
const { createClient } = supabase
const db = createClient(supabaseUrl, supabaseKey)


// REGISTER
async function register(){
    const email = document.getElementById('email').value
    const password = document.getElementById('password').value
    await db.auth.signUp({ email, password })
    alert("Kayıt başarılı.")
}


// LOGIN
async function login(){

    const email = document.getElementById('email').value
    const password = document.getElementById('password').value

    const { data, error } = await db.auth.signInWithPassword({ email, password })

    if(error){
        alert(error.message)
        return
    }

    document.getElementById("loginBox").style.display="none"

    const user = data.user

    const { data: profile } = await db
        .from("profiles")
        .select("*")
        .eq("user_id", user.id)
        .single()

    if(profile){

        const aktifUyelik = profile.membership_status === "active" 
            && new Date(profile.membership_end) > new Date()

        if(aktifUyelik || profile.kredi > 0){
            document.getElementById("plakaBox").style.display="block"
        }else{
            document.getElementById("buyBox").style.display="block"
        }

    }else{
        document.getElementById("buyBox").style.display="block"
    }
}


// TEK SORGU
async function tekSorguAl(){

    const { data: { user } } = await db.auth.getUser()

    const { data: profile } = await db
        .from("profiles")
        .select("*")
        .eq("user_id", user.id)
        .single()

    let mevcutKredi = profile?.kredi || 0

    await db.from("profiles").upsert({
        user_id: user.id,
        kredi: mevcutKredi + 1
    })

    alert("1 kredi eklendi!")

    document.getElementById("buyBox").style.display="none"
    document.getElementById("plakaBox").style.display="block"
}


// ÜYELİK
async function uyelikAl(){

    const { data: { user } } = await db.auth.getUser()

    let bitis = new Date()
    bitis.setDate(bitis.getDate() + 30)

    await db.from("profiles").upsert({
        user_id: user.id,
        membership_status: "active",
        membership_end: bitis
    })

    alert("30 günlük üyelik aktif!")

    document.getElementById("buyBox").style.display="none"
    document.getElementById("plakaBox").style.display="block"
}


// SORGU
async function sorgula(){

    const { data: { user } } = await db.auth.getUser()

    const { data: profile } = await db
        .from("profiles")
        .select("*")
        .eq("user_id", user.id)
        .single()

    const aktifUyelik = profile?.membership_status === "active" 
        && new Date(profile.membership_end) > new Date()

    if(!aktifUyelik){

        if(profile.kredi > 0){
            await db.from("profiles")
                .update({ kredi: profile.kredi - 1 })
                .eq("user_id", user.id)
        }else{
            alert("Kredi yok! Paket satın al.")
            return
        }
    }

    const plaka = document.getElementById("plaka").value

    document.getElementById("sonuc").innerHTML = `
        <p><b>Plaka:</b> ${plaka}</p>
        <p>Hasar Kaydı: Yok</p>
        <p>Kilometre: 132.000 km</p>
        <p>Değişen: 1 parça</p>
    `
}

</script>

</body>
</html>
