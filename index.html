<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Araç Analiz Sistemi</title>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
body{font-family:Arial;background:#0d47a1;color:white;text-align:center;padding:20px}
.box{background:white;color:black;padding:20px;border-radius:10px;max-width:520px;margin:auto;margin-top:20px}
input,button{padding:10px;width:100%;margin-top:10px}
button{background:#0d47a1;color:white;border:none;cursor:pointer}
.hidden{display:none}
.report{background:#f5f5f5;padding:15px;border-radius:8px;margin-top:15px;text-align:left}
.score{font-size:26px;font-weight:bold}
.riskLow{color:green}
.riskMid{color:#ff9800}
.riskHigh{color:red}
</style>
</head>

<body>

<h1>Araç Analiz Sistemi</h1>

<div class="box" id="authBox">
<h3>Giriş</h3>
<input type="email" id="email" placeholder="Email">
<input type="password" id="password" placeholder="Şifre">
<button onclick="register()">Kayıt Ol</button>
<button onclick="login()">Giriş Yap</button>
</div>

<div class="box hidden" id="userPanel">

<h3>Plaka Sorgu</h3>
<input id="plaka" placeholder="Plaka">

<button onclick="tekSorgu()">Tek Sorgu Satın Al (30 TL)</button>
<button onclick="uyelikAl()">Aylık Üyelik Al</button>

<button onclick="plakaSorgu()">Analiz Oluştur</button>
<button onclick="logout()">Çıkış Yap</button>

<div id="rapor"></div>
</div>

<div class="box hidden" id="adminPanel">
<h3>Admin Panel</h3>

<h4>Araç Ekle</h4>
<input id="v_plaka" placeholder="Plaka">
<input id="v_marka" placeholder="Marka">
<input id="v_model" placeholder="Model">
<input id="v_yil" placeholder="Yıl">
<input id="v_km" placeholder="KM">
<input id="v_ekspertiz" placeholder="Ekspertiz">
<button onclick="aracEkle()">Kaydet</button>

</div>

<script>

const SUPABASE_URL="https://lxuqpziqyrrwtzcksgwz.supabase.co";
const SUPABASE_ANON_KEY="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imx4dXFwemlxeXJyd3R6Y2tzZ3d6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA1NDM4MzMsImV4cCI6MjA4NjExOTgzM30.WOwK1D4eDNyPxYOe7HUuwndgPFQgmdmCcRxWsfyTSps";

const { createClient } = supabase;
const db=createClient(SUPABASE_URL,SUPABASE_ANON_KEY);

async function register(){
const {error}=await db.auth.signUp({email:emailEl().value,password:passwordEl().value});
if(error) alert(error.message);
else alert("Kaydınız başarıyla gerçekleşti. Emailinizi onaylayın.");
}

async function login(){
const {data,error}=await db.auth.signInWithPassword({email:emailEl().value,password:passwordEl().value});
if(error) return alert(error.message);
if(!data.user.email_confirmed_at) return alert("Email doğrulanmamış");
authBox().classList.add("hidden");
userPanel().classList.remove("hidden");
checkAdmin();
}

async function logout(){await db.auth.signOut();location.reload();}

async function checkAdmin(){
const {data:{user}}=await db.auth.getUser();
const {data}=await db.from("profiles").select("is_admin").eq("id",user.id).single();
if(data?.is_admin) adminPanel().classList.remove("hidden");
}

async function tekSorgu(){
const {data:{user}}=await db.auth.getUser();
await db.from("profiles").update({query_right:1}).eq("id",user.id);
alert("1 sorgu hakkı verildi");
}

async function uyelikAl(){
const {data:{user}}=await db.auth.getUser();
const bitis=new Date();
bitis.setMonth(bitis.getMonth()+1);
await db.from("profiles").update({membership_status:"aktif",membership_end:bitis}).eq("id",user.id);
alert("Üyelik aktif");
}

async function aracEkle(){
await db.from("vehicles").insert({
plaka:v_plaka.value.toUpperCase(),
marka:v_marka.value,
model:v_model.value,
yil:v_yil.value,
km:v_km.value,
ekspertiz:v_ekspertiz.value
});
alert("Araç kaydedildi");
}

async function plakaSorgu(){

const {data:{user}}=await db.auth.getUser();
const {data:profile}=await db.from("profiles").select("*").eq("id",user.id).single();

if(profile.membership_status==="aktif" && new Date(profile.membership_end)>new Date()){
}else if(profile.query_right>0){
await db.from("profiles").update({query_right:profile.query_right-1}).eq("id",user.id);
}else{
alert("Sorgu hakkınız yok");
return;
}

const plaka=plakaEl().value.toUpperCase();
const {data}=await db.from("vehicles").select("*").eq("plaka",plaka).single();
if(!data) return alert("Araç bulunamadı");

const analiz=aracAnalizMotoru(data);

rapor().innerHTML=`
<div class="report">
<h3>ARAÇ ANALİZ RAPORU</h3>

Plaka: ${data.plaka}<br>
Marka: ${data.marka}<br>
Model: ${data.model}<br>
Yıl: ${data.yil}<br>
KM: ${data.km}<br>

<hr>

Risk Skoru: ${analiz.risk}/100<br>
Araç Güven Puanı:
<span class="score ${analiz.renk}">${analiz.guven}</span>

<hr>

KM Analizi: ${analiz.km}<br>
Yaş Etkisi: ${analiz.yas}<br>
Ekspertiz Değerlendirme: ${analiz.ekspertiz}<br>

<hr>

<b>Sistem Yorumu:</b><br>
${analiz.yorum}

<br><br>
<button onclick="pdfOlustur()">PDF İndir</button>
</div>
`;
}

function aracAnalizMotoru(data){

let risk=0;
let yorum=[];

// yaş
const yas=2025-data.yil;
if(yas>10){risk+=25;yorum.push("Araç yaşı yüksek");}
else yorum.push("Yaş normal");

// km
const ort=15000*yas;
let kmDurum="Normal";
if(data.km>ort*1.5){risk+=30;kmDurum="KM yüksek";}
if(data.km<ort*0.5){risk+=25;kmDurum="KM düşürülmüş olabilir";}

// ekspertiz
let ekspertiz="Normal";
if(data.ekspertiz?.toLowerCase().includes("ağır")){
risk+=40;
ekspertiz="Ağır hasar kaydı mevcut";
}

// güven puanı
let guven=Math.max(100-risk,0);

let seviye="riskLow";
if(guven<70) seviye="riskMid";
if(guven<40) seviye="riskHigh";

return{
risk:risk,
guven:guven,
renk:seviye,
km:kmDurum,
yas: yas>10?"Yüksek risk":"Normal",
ekspertiz:ekspertiz,
yorum:yorum.join(", ")
};
}

function pdfOlustur(){
const { jsPDF } = window.jspdf;
const doc=new jsPDF();
doc.text("ARAÇ ANALİZ RAPORU",20,20);
doc.text(rapor().innerText,20,40);
doc.save("arac_analiz.pdf");
}

// helpers
const emailEl=()=>document.getElementById("email");
const passwordEl=()=>document.getElementById("password");
const authBox=()=>document.getElementById("authBox");
const userPanel=()=>document.getElementById("userPanel");
const adminPanel=()=>document.getElementById("adminPanel");
const plakaEl=()=>document.getElementById("plaka");
const rapor=()=>document.getElementById("rapor");

</script>
</body>
</html>
