<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Araç Analiz Sistemi</title>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
body{
    font-family: Arial;
    background:#0d47a1;
    color:white;
    text-align:center;
    padding:20px;
}
.box{
    background:white;
    color:black;
    padding:20px;
    border-radius:10px;
    max-width:450px;
    margin:auto;
    margin-top:20px;
}
input,button{
    padding:10px;
    width:100%;
    margin-top:10px;
}
button{
    background:#0d47a1;
    color:white;
    border:none;
    cursor:pointer;
}
.hidden{ display:none; }
.admin{ background:#00000022; padding:15px; border-radius:10px; margin-top:15px;}
</style>
</head>

<body>

<h1>Araç Analiz</h1>

<!-- AUTH -->
<div class="box" id="authBox">
    <h3>Giriş / Kayıt</h3>
    <input type="email" id="email" placeholder="Email">
    <input type="password" id="password" placeholder="Şifre">
    <button onclick="register()">Kayıt Ol</button>
    <button onclick="login()">Giriş Yap</button>
</div>

<!-- USER PANEL -->
<div class="box hidden" id="userPanel">
    <h3>Plaka Sorgu</h3>
    <input type="text" id="plaka" placeholder="Plaka">
    <button onclick="plakaSorgu()">Sorgula</button>

    <hr>

    <h3>Satın Alma</h3>
    <button onclick="tekSorguAl()">30 TL Tek Sorgu</button>
    <button onclick="uyelikAl()">Aylık Üyelik</button>

    <p id="durum"></p>

    <button onclick="logout()">Çıkış Yap</button>

    <!-- ADMIN -->
    <div id="adminPanel" class="admin hidden">
        <h3>Admin Panel</h3>
        <input type="email" id="adminEmail" placeholder="Kullanıcı Email">

        <button onclick="makeAdmin()">Admin Yap</button>
        <button onclick="uyelikVer()">1 Ay Üyelik Ver</button>
        <button onclick="krediVer()">1 Sorgu Hakkı Ver</button>
    </div>
</div>

<script>
const SUPABASE_URL = "https://lxuqpziqyrrwtzcksgwz.supabase.co";
const SUPABASE_ANON_KEY = "ANON_KEY_BURAYA";

const { createClient } = supabase;
const db = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

async function register(){
    const email = emailEl().value;
    const password = passEl().value;

    const { error } = await db.auth.signUp({ email, password });

    if(error) alert(error.message);
    else alert("Kaydınız başarıyla gerçekleşmiştir. Lütfen emailinizi kontrol ediniz.");
}

async function login(){
    const email = emailEl().value;
    const password = passEl().value;

    const { data, error } = await db.auth.signInWithPassword({ email, password });

    if(error){ alert(error.message); return; }
    if(!data.user.email_confirmed_at){ alert("Email doğrulanmamış!"); return; }

    authBox().classList.add("hidden");
    userPanel().classList.remove("hidden");

    checkAdmin();
    durumYaz();
}

async function logout(){
    await db.auth.signOut();
    location.reload();
}

async function plakaSorgu(){
    const { data:{user} } = await db.auth.getUser();
    if(!user) return;

    const { data:profile } = await db
        .from("profiles")
        .select("*")
        .eq("id", user.id)
        .single();

    if(profile.membership_status==="aktif"){
        alert("Plaka sonucu (üyelik)");
        return;
    }

    if(profile.credit > 0){
        await db.from("profiles")
            .update({ credit: profile.credit-1 })
            .eq("id", user.id);

        alert("Plaka sonucu (tek sorgu)");
        durumYaz();
        return;
    }

    alert("Üyelik veya kredi gerekli");
}

async function tekSorguAl(){
    const { data:{user} } = await db.auth.getUser();
    if(!user) return;

    const { data:profile } = await db
        .from("profiles")
        .select("credit")
        .eq("id", user.id)
        .single();

    await db.from("profiles")
        .update({ credit: (profile.credit||0)+1 })
        .eq("id", user.id);

    alert("1 sorgu hakkı eklendi (demo)");
    durumYaz();
}

async function uyelikAl(){
    const { data:{user} } = await db.auth.getUser();
    if(!user) return;

    const end = new Date();
    end.setMonth(end.getMonth()+1);

    await db.from("profiles").update({
        membership_status:"aktif",
        membership_end:end.toISOString()
    }).eq("id", user.id);

    alert("Üyelik aktif (demo)");
    durumYaz();
}

async function durumYaz(){
    const { data:{user} } = await db.auth.getUser();
    const { data:profile } = await db
        .from("profiles")
        .select("*")
        .eq("id", user.id)
        .single();

    document.getElementById("durum").innerHTML =
        "Üyelik: "+profile.membership_status+
        " | Kredi: "+(profile.credit||0);
}

async function checkAdmin(){
    const { data:{user} } = await db.auth.getUser();
    const { data } = await db
        .from("profiles")
        .select("is_admin")
        .eq("id", user.id)
        .single();

    if(data && data.is_admin)
        document.getElementById("adminPanel").classList.remove("hidden");
}

async function getUserByEmail(email){
    const { data } = await db.from("profiles").select("id,email");
    return data.find(x => x.email===email);
}

async function makeAdmin(){
    const email = document.getElementById("adminEmail").value;
    const u = await getUserByEmail(email);
    if(!u) return alert("Bulunamadı");

    await db.from("profiles")
        .update({ is_admin:true })
        .eq("id", u.id);

    alert("Admin yapıldı");
}

async function uyelikVer(){
    const email = document.getElementById("adminEmail").value;
    const u = await getUserByEmail(email);
    if(!u) return alert("Bulunamadı");

    const end = new Date();
    end.setMonth(end.getMonth()+1);

    await db.from("profiles").update({
        membership_status:"aktif",
        membership_end:end.toISOString()
    }).eq("id", u.id);

    alert("Üyelik verildi");
}

async function krediVer(){
    const email = document.getElementById("adminEmail").value;
    const u = await getUserByEmail(email);
    if(!u) return alert("Bulunamadı");

    const { data:profile } = await db
        .from("profiles")
        .select("credit")
        .eq("id", u.id)
        .single();

    await db.from("profiles")
        .update({ credit:(profile.credit||0)+1 })
        .eq("id", u.id);

    alert("Kredi verildi");
}

function emailEl(){ return document.getElementById("email"); }
function passEl(){ return document.getElementById("password"); }
function authBox(){ return document.getElementById("authBox"); }
function userPanel(){ return document.getElementById("userPanel"); }
</script>

</body>
</html>
