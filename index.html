<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Araç Analiz - Güvenli Sürüm</title>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
body{
    font-family: Arial;
    background:#0d47a1;
    color:white;
    text-align:center;
    padding:30px;
}
.box{
    background:white;
    color:black;
    padding:20px;
    border-radius:10px;
    max-width:400px;
    margin:auto;
    margin-top:20px;
}
input,button{
    padding:10px;
    width:100%;
    margin-top:10px;
}
button{
    background:#0d47a1;
    color:white;
    border:none;
    cursor:pointer;
}
.hidden{
    display:none;
}
.legal{
    font-size:12px;
    color:yellow;
    margin-top:20px;
}
</style>
</head>
<body>

<h1>Araç Analiz Sistemi</h1>

<div class="box" id="authBox">
    <h3>Kullanıcı Giriş</h3>
    <input type="email" id="email" placeholder="Email">
    <input type="password" id="password" placeholder="Şifre">
    <button onclick="register()">Kayıt Ol</button>
    <button onclick="login()">Giriş Yap</button>
</div>

<div class="box hidden" id="userPanel">
    <h3>Plaka Sorgu</h3>
    <input type="text" id="plaka" placeholder="Plaka gir">
    <button onclick="plakaSorgu()">Sorgula</button>

    <hr>

    <h3>Analiz Satın Al</h3>
    <button onclick="bireyselAl()">30 TL Tek Sorgu</button>
    <button onclick="uyelikAl()">Aylık Üyelik</button>

    <button onclick="logout()">Çıkış Yap</button>

    <p class="legal">
    Not: Bu platform yalnızca bilgilendirme amaçlıdır. Araç bilgileri resmi kayıtlardan doğrulanmalıdır. Site yönetimi hukuki sorumluluk kabul etmez.
    </p>
</div>

<script>
const SUPABASE_URL = "https://lxuqpziqyrrwtzcksgwz.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imx4dXFwemlxeXJyd3R6Y2tzZ3d6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA1NDM4MzMsImV4cCI6MjA4NjExOTgzM30.WOwK1D4eDNyPxYOe7HUuwndgPFQgmdmCcRxWsfyTSps";

const { createClient } = supabase;
const db = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

// Vercel site URL
const REDIRECT_URL = "https://seninsiten.vercel.app";

async function register(){
    const email = document.getElementById('email').value
    const password = document.getElementById('password').value

    const { error } = await db.auth.signUp({
        email,
        password,
        options: { emailRedirectTo: REDIRECT_URL }
    });

    if(error){
        alert(error.message)
    }else{
        alert("Kayıt başarılı! Email doğrulama maili gönderildi.")
    }
}

async function login(){
    const email = document.getElementById('email').value
    const password = document.getElementById('password').value

    const { data, error } = await db.auth.signInWithPassword({
        email,
        password,
        options: { emailRedirectTo: REDIRECT_URL }
    });

    if(error){
        alert(error.message)
        return
    }

    if(!data.user.email_confirmed_at){
        alert("Email doğrulanmamış! Lütfen mail linkine tıklayın.")
        return
    }

    document.getElementById("authBox").classList.add("hidden")
    document.getElementById("userPanel").classList.remove("hidden")
}

async function logout(){
    await db.auth.signOut()
    location.reload()
}

async function bireyselAl(){
    const { data: { user } } = await db.auth.getUser()
    if(!user){ alert("Giriş yap"); return }

    const token = prompt("Demo için Iyzico token giriniz") // Test amaçlı
    const response = await fetch("/api/iyzico_payment", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ userId: user.id, amount: 30, paymentToken: token })
    });
    const result = await response.json();
    if(result.success){
        alert("Ödeme başarılı! Tek sorgu hakkı eklendi.")
    } else {
        alert("Ödeme başarısız: " + result.message)
    }
}

async function uyelikAl(){
    const { data: { user } } = await db.auth.getUser()
    if(!user){ alert("Giriş yap"); return }

    const bitis = new Date()
    bitis.setMonth(bitis.getMonth()+1)

    const response = await fetch("/api/iyzico_payment", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ userId: user.id, amount: 100, paymentToken: "TOKEN_FOR_SUBSCRIPTION" })
    });
    const result = await response.json();
    if(result.success){
        alert("Üyelik aktif edildi.")
    } else {
        alert("Ödeme başarısız: " + result.message)
    }
}

async function plakaSorgu(){
    const plaka = document.getElementById("plaka").value.toUpperCase()
    alert("Plaka sorgulandı (demo): " + plaka)
}
</script>

</body>
</html>
